name: Deploy to Azure App Service

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.13'
  AZURE_WEBAPP_NAME: 'app-dev-taskmanager-westeurope'
  RESOURCE_GROUP: 'rg-dev-taskmanager-westeurope'

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run pytest
      env:
        DJANGO_SETTINGS_MODULE: 'taskmanager.settings.testing'
      run: |
        pytest tests/ --tb=short -v --cov --cov-report=term-missing
    
    - name: Check code formatting with black
      run: |
        pip install black
        black --check .
      continue-on-error: true

  build:
    runs-on: ubuntu-latest
    needs: test
    name: Build Application
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Collect static files
      env:
        DJANGO_SETTINGS_MODULE: 'taskmanager.settings.production'
        SECRET_KEY: 'build-secret-key-not-used-in-production'
        DB_HOST: 'localhost'
        DB_NAME: 'dummy'
        DB_USER: 'dummy'
        DB_PASSWORD: 'dummy'
      run: |
        python manage.py collectstatic --noinput --settings=taskmanager.settings.production
    
    - name: Upload artifact for deployment
      uses: actions/upload-artifact@v4
      with:
        name: python-app
        path: |
          .
          !.venv/
          !.git/
          !.github/
          !tests/
          !infrastructure/
          !specs/

  deploy:
    runs-on: ubuntu-latest
    needs: build
    name: Deploy to Azure
    environment:
      name: 'production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: python-app
        path: .
    
    - name: Deploy to Azure Web App
      id: deploy-to-webapp
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        startup-command: 'gunicorn --bind=0.0.0.0 --timeout 600 taskmanager.wsgi'
    
    - name: Run database migrations
      uses: azure/cli@v2
      with:
        azcliversion: latest
        inlineScript: |
          az webapp ssh --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --command "python manage.py migrate --noinput"
      env:
        AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
